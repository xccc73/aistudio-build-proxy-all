name: 自动构建并推送 GHCR 镜像
on:
  push:
    branches: [ main ]  # 当推送代码到 main 分支时触发
    tags: [ 'v*' ]      # 当推送标签（如 v1.0）时也触发

jobs:
  build-and-push:
    runs-on: ubuntu-latest  # 使用 GitHub 提供的 Ubuntu 服务器
    steps:
      # 步骤1：拉取仓库代码到虚拟服务器
      - name: 拉取代码
        uses: actions/checkout@v4

      # 步骤2：设置 Docker 构建环境（支持多平台构建）
      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤3：登录到 GHCR（利用 GitHub 内置令牌，无需手动生成 PAT）
      - name: 登录 GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}  # 自动获取当前仓库所有者用户名
          password: ${{ secrets.GITHUB_TOKEN }}  # GitHub 自动生成的临时令牌，含必要权限

      # 步骤4：构建并推送镜像到 GHCR
      - name: 构建并推送镜像
        uses: docker/build-push-action@v5
        with:
          context: .  # Dockerfile 所在目录（当前仓库根目录）
          push: true  # 启用推送
          tags: |
            # 镜像标签格式：ghcr.io/用户名/仓库名:标签
            ghcr.io/${{ github.repository_owner }}/${{ github.repository_name }}:latest
            ghcr.io/${{ github.repository_owner }}/${{ github.repository_name }}:${{ github.sha }}  # 用 commit 哈希作为标签
